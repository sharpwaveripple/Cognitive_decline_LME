---
title: "Brain Paper Title Here"
author: "Jonathan Tay"
date: "November 15, 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

In our study, we sought to examine the longitudinal relationships between white
matter hyperintensities, hippocampal volumes, and age, and how they may explain
cognitive decline.

First, load up the data and apply transforms.

```{r}
df <- read.csv("../data/RUNDMC_data_long.csv", sep=";", dec=",")
df$subject <- factor(df$rundmcs)
df$logwmh <- log(df$wmh)
df$age06 <- scale(df$age06)
df$agesq <- df$age06^2
df$timesq <- df$time^2
```

## Visualizing the data

Since we want to fit a linear mixed model, let's make sure that all the
variables are (roughly) normally distributed:

```{r, echo=F}
hist(df$logwmh)
hist(df$hv)
hist(df$age)
hist(df$cognitiveindex)
```

And then let's make sure that the relationship between IVs and cognitive
decline is (roughly) linear. It would be easiest to do this with visualizations. So let's define a few functions for plotting:

```{r warning=FALSE}
library(ggplot2)

spaghettiPlot <- function(x, y, group, xLab, yLab) {
    ggplot(df, aes(x, y, group=group)) +
    geom_line() + geom_point() +
    stat_smooth(aes(group=1), method=lm, colour="#cc0000", fill="#c3c3c3", alpha=0.6) +
    theme_bw(base_size=22) +
    labs(x=xLab, y=yLab)
}

scatterPlot <- function(x, y, m, xLab, yLab, mLab) {
  ggplot(df, aes(x, y)) + geom_point(aes(color=m), size=2) +
  scale_color_gradient(low="cyan", high="blue") +
  labs(x=xLab, y=yLab, colour=mLab) +
  theme_classic()
}
```


Our spaghetti plots tell us that the relationships between log-normalized white matter hyperintensities, hippocampal volumes, and the cognitive index are pretty linear over time:

```{r warning=FALSE, echo=F}
spaghettiPlot(df$logwmh, df$cognitiveindex, df$rundmcs,
              "White matter hyperintensities", "Cognitive index")

spaghettiPlot(df$hv, df$cognitiveindex, df$rundmcs,
              "Hippocampal volume", "Cognitive index")
```


We know, however, that age is a critical determinant of all our IVs and our DV. Our scatterplot will plot the relationship between the IV and DV while colour coding according to age:


```{r warning=FALSE, echo=F}
scatterPlot(df$logwmh, df$cognitiveindex, df$age,
            "White matter hyperintensities", "Cognitive index", "Age")

scatterPlot(df$hv, df$cognitiveindex, df$age,
            "Hippocampal volumes", "Cognitive index", "Age")
```

We can clearly see here an effect of age. In order to describe the complex
relationships between age, white matter hyperintensities, hippocampal volumes,
and cognitive function, we used linear mixed effects regression (LMER). This
allowed us to describe fixed effects (i.e., WMH, HV, age) in tandem with
subject-specific random effects.

Age, in the context of longitudinal studies, can be decomposed into two
components: age at baseline and follow-up time (Morrell, Brant & Ferrucci,
2009). Age at baseline represents cross-sectional differences between subjects,
while follow-up time represents longitudinal differences within individuals. 

Before examining the effects of WMH and HV, let us first examine age-related
cognitive decline using this framework. Two fixed effects were specified: one
for baseline age, and another for time between visits. These two represent
population effects. The coefficient for age represents the relationship between
cognition and age, while the coefficient for time represents how cognition
changes as time progresses. We also included two random effects: one for the
intercept and one for the slope of time. This is because we expect individual differences in changes in cognition.

Here, the random intercept corresponds to individual variability in cognition
at each timepoint, while the random slope corresponds to individual differences
in the rate of change between timepoints. Because all subjects have a roughly
equivalent time between assessments (5 years then 4 years), we do not expect
much variability (measured by the variance and standard deviation of the random
effects. That is precisely what we see:


```{r message=F}
library(lmerTest)
fit <- lmer(cognitiveindex ~ 1 + age06 + time + (1 + time|subject), data = df)
summary(fit)
```

As expected, the variance term in the random slope of time is close to 0, indicating little individual variability.

Both fixed effects are significant as expected. Age is a significant determinant of cognition, as expected. Furthermore, the linear effect of time is significant, indicating that the passage of time impacts cognition. 
. Note the interpretation of the slope and
intercept of the random effects of time. The variance is a measure of ...
intercept significant, slope not (bc rate of change is constant)

for baseline age, another for time between visits, and a quadratic term for
age. As previous research has shown a quadratic relationship between age and
WMH (van Leijsen et al., 2017), we wanted to see if this also applied to age and cognition. 

```{r}
library(lmerTest)

fit <- lmer(cognitiveindex ~ age06 + time + agesq + (1+time|subject), data=df)
fit2 <- lmer(cognitiveindex ~ age06 + time + agesq + (time||subject), data=df)

anova(fit)
anova(fit, fit2)

#lmeTime1 <- lmer(cognitiveindex ~ age + time + timesq + (1 + time|rundmcs), data=df)

#lmeWMH <- lmer(cognitiveindex ~ logwmh + age + (1|rundmcs), data=df)
#lmeHV <- lmer(cognitiveindex ~ hv + age + (1|rundmcs), data=df)
#summary(lmeWMH)
#summary(lmeHV)
#summary(lmeTime1)
```

Does this mean WMH are synonymous with age-related cognitive decline? It's possible that the non-log transformed version is significant because it doesn't accurately describe the relationship
